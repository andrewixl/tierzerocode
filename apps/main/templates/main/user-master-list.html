{% extends 'main/base.html' %}
{% load static %}
{% block content %}
<main class="content">
    <div class="container-fluid p-0">
        <div class="mb-3">
            <h1 class="h3 d-inline align-middle">Master List of User Authentication</h1>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Filter Dropdown -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="highest-auth-strength-filter" class="form-label fw-bold">Filter by Highest Authentication Strength:</label>
                                <select id="highest-auth-strength-filter" class="form-control" multiple="multiple">
                                    {% for auth_strength in auth_strengths %}
                                    <option value="{{ auth_strength }}">{{ auth_strength }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="lowest-auth-strength-filter" class="form-label fw-bold">Filter by Lowest Authentication Strength:</label>
                                <select id="lowest-auth-strength-filter" class="form-control" multiple="multiple">
                                    {% for auth_strength in auth_strengths %}
                                    <option value="{{ auth_strength }}">{{ auth_strength }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="persona-filter" class="form-label fw-bold">Filter by Persona:</label>
                                <select id="persona-filter" class="form-control" multiple="multiple">
                                    {% for persona in personas %}
                                    <option value="{{ persona }}">{{ persona }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <table id="datatables-responsive" class="table table-striped" style="width:100%">
                            <thead>
                                <tr>
                                    <th>UPN</th>
                                    <th>Persona</th>
                                    <th>Created At</th>
                                    <th>Last Sign-on</th>
                                    <th>Highest Authentication Strength</th>
                                    <th>Lowest Authentication Strength</th>
                                    <th>Passkey</th>
                                    <th>MS Auth Passkey</th>
                                    <th>WHfB</th>
                                    <th>Phone Sign-in</th>
                                    <th>Push</th>
                                    <th>OTP</th>
                                    <th>TAP</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Sec. Qs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- DataTables will populate this via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<!-- Include jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include Select2 CSS and JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
<!-- Include DataTables CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<!-- Include DataTables Buttons extension CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.0.0/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.0.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.0.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.0.0/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<!-- Include XLSX library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    .form-label {
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        min-height: 38px;
    }
    
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #007bff;
        border: 1px solid #0056b3;
        border-radius: 0.25rem;
        color: white;
        padding: 2px 8px;
        margin: 2px;
    }
    
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }
    
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        color: #f8f9fa;
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize Select2 for multi-select dropdown
        $('#highest-auth-strength-filter').select2({
            placeholder: "Select Authentication Strengths(s)",
            allowClear: true
        });
        $('#lowest-auth-strength-filter').select2({
            placeholder: "Select Authentication Strengths(s)",
            allowClear: true
        });
        $('#persona-filter').select2({
            placeholder: "Select Persona(s)",
            allowClear: true
        });

        // Datatables Responsive
        var table = $("#datatables-responsive").DataTable({
            serverSide: true,
            processing: true,
            ajax: {
                url: "{% url 'user_master_list_api' %}",
                data: function (d) {
                    d.highest_auth = $('#highest-auth-strength-filter').val();
                    d.lowest_auth = $('#lowest-auth-strength-filter').val();
                    d.personas = $('#persona-filter').val();
                }
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: 'Export to Excel',
                    title: 'User Master List',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15] // Exclude hidden columns
                    }
                },
                {
                    extend: 'pdfHtml5',
                    text: 'Export to PDF',
                    title: 'User Master List',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15] // Exclude hidden columns
                    }
                },
                {
                    extend: 'print',
                    text: 'Print',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15] // Exclude hidden columns
                    }
                }
            ],
            columnDefs: [
                {
                    targets: [4, 5], // Index of the hidden column
                    visible: false
                },
                {
                    targets: [3], // The index of your Last Sign-on column
                    type: 'date'
                }
            ]
        });

        // Custom export functions that use the export API
        function exportToExcel() {
            $.ajax({
                url: "{% url 'user_master_list_export_api' %}",
                method: 'GET',
                data: {
                    highest_auth: $('#highest-auth-strength-filter').val(),
                    lowest_auth: $('#lowest-auth-strength-filter').val(),
                    personas: $('#persona-filter').val(),
                    'search[value]': table.search()
                },
                success: function(response) {
                    // Create workbook and worksheet
                    var wb = XLSX.utils.book_new();
                    var ws = XLSX.utils.aoa_to_sheet([
                        ['UPN', 'Persona', 'Created At', 'Last Sign-on', 'Passkey', 'MS Auth Passkey', 'WHfB', 'Phone Sign-in', 'Push', 'OTP', 'TAP', 'Phone', 'Email', 'Sec. Qs']
                    ]);
                    
                    // Add data rows
                    XLSX.utils.sheet_add_aoa(ws, response.data, {origin: 'A2'});
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'User Master List');
                    
                    // Save file
                    XLSX.writeFile(wb, 'user_master_list.xlsx');
                },
                error: function() {
                    alert('Error exporting data. Please try again.');
                }
            });
        }

        function exportToPDF() {
            $.ajax({
                url: "{% url 'user_master_list_export_api' %}",
                method: 'GET',
                data: {
                    highest_auth: $('#highest-auth-strength-filter').val(),
                    lowest_auth: $('#lowest-auth-strength-filter').val(),
                    personas: $('#persona-filter').val(),
                    'search[value]': table.search()
                },
                success: function(response) {
                    // Create PDF document
                    var docDefinition = {
                        content: [
                            {text: 'User Master List', style: 'header'},
                            {
                                table: {
                                    headerRows: 1,
                                    widths: ['*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*'],
                                    body: [
                                        ['UPN', 'Persona', 'Created At', 'Last Sign-on', 'Passkey', 'MS Auth Passkey', 'WHfB', 'Phone Sign-in', 'Push', 'OTP', 'TAP', 'Phone', 'Email', 'Sec. Qs']
                                    ].concat(response.data)
                                }
                            }
                        ],
                        styles: {
                            header: {
                                fontSize: 18,
                                bold: true,
                                margin: [0, 0, 0, 10]
                            }
                        }
                    };
                    
                    pdfMake.createPdf(docDefinition).download('user_master_list.pdf');
                },
                error: function() {
                    alert('Error exporting data. Please try again.');
                }
            });
        }

        function exportToPrint() {
            $.ajax({
                url: "{% url 'user_master_list_export_api' %}",
                method: 'GET',
                data: {
                    highest_auth: $('#highest-auth-strength-filter').val(),
                    lowest_auth: $('#lowest-auth-strength-filter').val(),
                    personas: $('#persona-filter').val(),
                    'search[value]': table.search()
                },
                success: function(response) {
                    // Create print window
                    var printWindow = window.open('', '_blank');
                    var tableHtml = '<html><head><title>User Master List</title>';
                    tableHtml += '<style>table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid black; padding: 8px; text-align: left; } th { background-color: #f2f2f2; }</style>';
                    tableHtml += '</head><body>';
                    tableHtml += '<h1>User Master List</h1>';
                    tableHtml += '<table>';
                    tableHtml += '<thead><tr><th>UPN</th><th>Persona</th><th>Created At</th><th>Last Sign-on</th><th>Passkey</th><th>MS Auth Passkey</th><th>WHfB</th><th>Phone Sign-in</th><th>Push</th><th>OTP</th><th>TAP</th><th>Phone</th><th>Email</th><th>Sec. Qs</th></tr></thead>';
                    tableHtml += '<tbody>';
                    
                    response.data.forEach(function(row) {
                        tableHtml += '<tr>';
                        row.forEach(function(cell) {
                            tableHtml += '<td>' + cell + '</td>';
                        });
                        tableHtml += '</tr>';
                    });
                    
                    tableHtml += '</tbody></table></body></html>';
                    
                    printWindow.document.write(tableHtml);
                    printWindow.document.close();
                    printWindow.print();
                },
                error: function() {
                    alert('Error exporting data. Please try again.');
                }
            });
        }

        $('#highest-auth-strength-filter').on('change', function() { table.ajax.reload(); });
        $('#lowest-auth-strength-filter').on('change', function() { table.ajax.reload(); });
        $('#persona-filter').on('change', function() { table.ajax.reload(); });

        // Override export buttons to use custom API
        setTimeout(function() {
            $('.dt-buttons .dt-button').each(function() {
                var buttonText = $(this).text();
                if (buttonText === 'Export to Excel') {
                    $(this).off('click').on('click', function(e) {
                        e.preventDefault();
                        exportToExcel();
                    });
                } else if (buttonText === 'Export to PDF') {
                    $(this).off('click').on('click', function(e) {
                        e.preventDefault();
                        exportToPDF();
                    });
                } else if (buttonText === 'Print') {
                    $(this).off('click').on('click', function(e) {
                        e.preventDefault();
                        exportToPrint();
                    });
                }
            });
        }, 100);
    });
</script>
{% endblock %}
