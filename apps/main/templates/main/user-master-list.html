{% extends 'main/base.html' %}
{% load static %}
{% block content %}
<main class="content">
    <div class="container-fluid p-0">
        <div class="mb-3">
            <h1 class="h3 d-inline align-middle">Master List of User Authentication</h1>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Filter Dropdowns -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="highest-auth-strength-filter" class="form-label fw-bold">Filter by Highest Authentication Strength:</label>
                                <select id="highest-auth-strength-filter" class="form-control" multiple="multiple">
                                    {% for auth_strength in auth_strengths %}
                                    <option value="{{ auth_strength }}">{{ auth_strength }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="lowest-auth-strength-filter" class="form-label fw-bold">Filter by Lowest Authentication Strength:</label>
                                <select id="lowest-auth-strength-filter" class="form-control" multiple="multiple">
                                    {% for auth_strength in auth_strengths %}
                                    <option value="{{ auth_strength }}">{{ auth_strength }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="persona-filter" class="form-label fw-bold">Filter by Persona:</label>
                                <select id="persona-filter" class="form-control" multiple="multiple">
                                    {% for persona in personas %}
                                    <option value="{{ persona }}">{{ persona }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="table-responsive">
                            <table id="datatables-responsive" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>UPN</th>
                                        <th>Persona</th>
                                        <th>Created At</th>
                                        <th>Last Sign-on</th>
                                        <th>Highest Authentication Strength</th>
                                        <th>Lowest Authentication Strength</th>
                                        <th>Passkey</th>
                                        <th>MS Auth Passkey</th>
                                        <th>WHfB</th>
                                        <th>Phone Sign-in</th>
                                        <th>Push</th>
                                        <th>OTP</th>
                                        <th>TAP</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Sec. Qs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- DataTables will populate this via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<!-- External Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        min-height: 38px;
    }
    
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #007bff;
        border: 1px solid #0056b3;
        border-radius: 0.25rem;
        color: white;
        padding: 2px 8px;
        margin: 2px;
    }
    
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }
    
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize Select2 for multi-select dropdowns
        $('#highest-auth-strength-filter, #lowest-auth-strength-filter, #persona-filter').select2({
            placeholder: "Select options...",
            allowClear: true
        });

        // Initialize DataTable
        var table = $("#datatables-responsive").DataTable({
            serverSide: true,
            processing: true,
            ajax: {
                url: "{% url 'user_master_list_api' %}",
                data: function (d) {
                    d.highest_auth = $('#highest-auth-strength-filter').val();
                    d.lowest_auth = $('#lowest-auth-strength-filter').val();
                    d.personas = $('#persona-filter').val();
                }
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: 'Export to Excel',
                    title: 'User Master List',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
                    },
                    action: function (e, dt, button, config) {
                        // Get all data from server for export
                        var exportData = {
                            highest_auth: $('#highest-auth-strength-filter').val(),
                            lowest_auth: $('#lowest-auth-strength-filter').val(),
                            personas: $('#persona-filter').val(),
                            export: true,
                            length: -1 // Request all data
                        };
                        
                        $.ajax({
                            url: "{% url 'user_master_list_export_api' %}",
                            method: 'GET',
                            data: exportData,
                            success: function(response) {
                                console.log('Export response:', response);
                                if (response.data && response.data.length > 0) {
                                    // Create workbook and worksheet
                                    var wb = XLSX.utils.book_new();
                                    var headers = ['UPN', 'Persona', 'Created At', 'Last Sign-on', 'Passkey', 'MS Auth Passkey', 'WHfB', 'Phone Sign-in', 'Push', 'OTP', 'TAP', 'Phone', 'Email', 'Sec. Qs'];
                                    var ws = XLSX.utils.aoa_to_sheet([headers]);
                                    
                                    // Add data rows
                                    XLSX.utils.sheet_add_aoa(ws, response.data, {origin: 'A2'});
                                    
                                    // Set column widths
                                    ws['!cols'] = [
                                        { width: 30 }, { width: 18 }, { width: 18 }, { width: 20 },
                                        { width: 12 }, { width: 15 }, { width: 12 }, { width: 15 },
                                        { width: 12 }, { width: 12 }, { width: 12 }, { width: 12 },
                                        { width: 12 }, { width: 12 }
                                    ];
                                    
                                    // Add worksheet to workbook
                                    XLSX.utils.book_append_sheet(wb, ws, 'User Master List');
                                    
                                    // Save file
                                    var timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                                    XLSX.writeFile(wb, `User_Master_List_${timestamp}.xlsx`);
                                } else {
                                    console.log('No data received or empty response');
                                    alert('No data available for export.');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Export error:', xhr.responseText, status, error);
                                alert('Error exporting data. Please check the console for details.');
                            }
                        });
                    }
                },
                {
                    extend: 'pdfHtml5',
                    text: 'Export to PDF',
                    title: 'User Master List',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
                    },
                    action: function (e, dt, button, config) {
                        // Get all data from server for export
                        var exportData = {
                            highest_auth: $('#highest-auth-strength-filter').val(),
                            lowest_auth: $('#lowest-auth-strength-filter').val(),
                            personas: $('#persona-filter').val(),
                            export: true,
                            length: -1 // Request all data
                        };
                        
                        $.ajax({
                            url: "{% url 'user_master_list_export_api' %}",
                            method: 'GET',
                            data: exportData,
                            success: function(response) {
                                console.log('Export response:', response);
                                if (response.data && response.data.length > 0) {
                                    // Create PDF document
                                    var docDefinition = {
                                        pageSize: 'A4',
                                        pageOrientation: 'landscape',
                                        pageMargins: [20, 80, 20, 80],
                                        header: {
                                            text: 'User Master List - Tier Zero CO.D.E',
                                            alignment: 'center',
                                            fontSize: 16,
                                            bold: true,
                                            margin: [0, 20, 0, 0]
                                        },
                                        footer: function(currentPage, pageCount) {
                                            return {
                                                text: 'Page ' + currentPage.toString() + ' of ' + pageCount + ' | Generated on ' + new Date().toLocaleDateString(),
                                                alignment: 'center',
                                                fontSize: 9,
                                                margin: [0, 0, 0, 20]
                                            };
                                        },
                                        content: [
                                            {
                                                table: {
                                                    headerRows: 1,
                                                    widths: ['*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*', '*'],
                                                    body: [
                                                        ['UPN', 'Persona', 'Created At', 'Last Sign-on', 'Passkey', 'MS Auth', 'WHfB', 'Phone', 'Push', 'OTP', 'TAP', 'Phone', 'Email', 'Sec. Qs']
                                                    ].concat(response.data)
                                                }
                                            }
                                        ]
                                    };
                                    
                                    var timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                                    pdfMake.createPdf(docDefinition).download(`User_Master_List_${timestamp}.pdf`);
                                } else {
                                    console.log('No data received or empty response');
                                    alert('No data available for export.');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Export error:', xhr.responseText, status, error);
                                alert('Error exporting data. Please check the console for details.');
                            }
                        });
                    }
                },
                {
                    extend: 'print',
                    text: 'Print',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
                    },
                    action: function (e, dt, button, config) {
                        // Get all data from server for export
                        var exportData = {
                            highest_auth: $('#highest-auth-strength-filter').val(),
                            lowest_auth: $('#lowest-auth-strength-filter').val(),
                            personas: $('#persona-filter').val(),
                            export: true,
                            length: -1 // Request all data
                        };
                        
                        $.ajax({
                            url: "{% url 'user_master_list_export_api' %}",
                            method: 'GET',
                            data: exportData,
                            success: function(response) {
                                console.log('Export response:', response);
                                if (response.data && response.data.length > 0) {
                                    // Create print window
                                    var printWindow = window.open('', '_blank');
                                    var timestamp = new Date().toLocaleString();
                                    
                                    var tableHtml = `
                                        <html>
                                        <head>
                                            <title>User Master List - Tier Zero CO.D.E</title>
                                            <style>
                                                body { font-family: Arial, sans-serif; margin: 20px; }
                                                table { width: 100%; border-collapse: collapse; }
                                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                                th { background-color: #f2f2f2; font-weight: bold; }
                                                .header { text-align: center; margin-bottom: 20px; }
                                                @media print { body { margin: 0; } }
                                            </style>
                                        </head>
                                        <body>
                                            <div class="header">
                                                <h1>User Master List</h1>
                                                <p>Tier Zero CO.D.E - Generated on ${timestamp}</p>
                                                <p>Total Users: ${response.data.length}</p>
                                            </div>
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>UPN</th>
                                                        <th>Persona</th>
                                                        <th>Created At</th>
                                                        <th>Last Sign-on</th>
                                                        <th>Passkey</th>
                                                        <th>MS Auth</th>
                                                        <th>WHfB</th>
                                                        <th>Phone Sign-in</th>
                                                        <th>Push</th>
                                                        <th>OTP</th>
                                                        <th>TAP</th>
                                                        <th>Phone</th>
                                                        <th>Email</th>
                                                        <th>Sec. Qs</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;
                                    
                                    response.data.forEach(function(row) {
                                        tableHtml += '<tr>';
                                        row.forEach(function(cell) {
                                            tableHtml += `<td>${cell}</td>`;
                                        });
                                        tableHtml += '</tr>';
                                    });
                                    
                                    tableHtml += `
                                                </tbody>
                                            </table>
                                        </body>
                                        </html>`;
                                    
                                    printWindow.document.write(tableHtml);
                                    printWindow.document.close();
                                    
                                    setTimeout(function() {
                                        printWindow.print();
                                    }, 500);
                                } else {
                                    console.log('No data received or empty response');
                                    alert('No data available for export.');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Export error:', xhr.responseText, status, error);
                                alert('Error exporting data. Please check the console for details.');
                            }
                        });
                    }
                }
            ],
            columnDefs: [
                {
                    targets: [4, 5], // Hide authentication strength columns
                    visible: false
                },
                {
                    targets: [3], // Last Sign-on column
                    type: 'date'
                }
            ]
        });

        // Filter change handlers
        $('#highest-auth-strength-filter, #lowest-auth-strength-filter, #persona-filter').on('change', function() {
            table.ajax.reload();
        });
    });
</script>
{% endblock %}
