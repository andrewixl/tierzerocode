{% extends 'main/base.html' %}
{% load static %}
  {% block content %}
			<main class="content">
				<div class="container-fluid p-0">

					<div class="row mb-2 mb-xl-3">
						<div class="col-auto d-none d-sm-block">
							<h3><strong>{{ persona }}s Analytics</strong> Dashboard</h3>
						</div>
					</div>
					<div class="row">
						<div class="col-xl-12 col-xxl-12 d-flex">
							<div class="w-100">
								<div class="row">
									<div class="col-sm-2">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">{{ persona }}</h5>
													</div>
													<div class="col-auto">
														<div class="stat text-primary">
															<i class="align-middle" data-feather="list"></i>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3">{{ persona_count }} Users</h1>
											</div>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">MFA Enrollment</h5>
													</div>
													<div class="col-auto">
														<div class="stat text-primary">
															<i class="align-middle" data-feather="list"></i>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3">{{ percent_mfa }}%</h1>
												<div class="mb-0">
													<!-- <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25% </span> -->
													<span class="text-muted">{{ count_mfa }} / {{ persona_count }}</span>
												</div>
											</div>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Phishing Resistant</h5>
													</div>
													<div class="col-auto">
														<div class="stat text-primary">
															<i class="align-middle" data-feather="list"></i>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3">{{ percent_phishing_resistant }}%</h1>
												<div class="mb-0">
													<!-- <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25% </span> -->
													<span class="text-muted">{{ count_phishing_resistant }} / {{ persona_count }}</span>
												</div>
											</div>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Passwordless</h5>
													</div>
													<div class="col-auto">
														<div class="stat text-primary">
															<i class="align-middle" data-feather="list"></i>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3">{{ percent_passwordless }}%</h1>
												<div class="mb-0">
													<!-- <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25% </span> -->
													<span class="text-muted">{{ count_passwordless }} / {{ persona_count }}</span>
												</div>
											</div>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Phishing Resistant Enforced</h5>
													</div>
													<div class="col-auto">
														<div class="stat text-primary">
															<i class="align-middle" data-feather="list"></i>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3">0.00%</h1>
												<div class="mb-0">
													<!-- <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25% </span> -->
													<span class="text-muted">0 / {{ persona_count }}</span>
												</div>
											</div>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Passwordless Enforced</h5>
													</div>
													<div class="col-auto">
														<div class="stat text-primary">
															<i class="align-middle" data-feather="list"></i>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3">0.00%</h1>
												<div class="mb-0">
													<!-- <span class="badge badge-success-light"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25% </span> -->
													<span class="text-muted">0 / {{ persona_count }}</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-12 col-md-6 col-xxl-3 d-flex order-1 order-xxl-3">
							<div class="card flex-fill w-100">
								<div class="card-header">
									<h5 class="card-title mb-0">MFA Method Adoption</h5>
								</div>
								<div class="card-body d-flex">
									<div class="align-self-center w-100">
										<div class="py-3">
											<div class="chart chart-xs">
												<canvas id="adoption-auth-pie"></canvas>
											</div>
										</div>

										<table class="table mb-0">
											<tbody>
												<tr>
													<td><i class="fas fa-circle text-primary fa-fw"></i> Windows Hello for Business</td>
													<td class="text-end">{{auth_method_adoption_data.0}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-secondary fa-fw"></i> Passkey Device</td>
													<td class="text-end">{{auth_method_adoption_data.1}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-success fa-fw"></i> Passkey Authenticator</td>
													<td class="text-end">{{auth_method_adoption_data.2}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-danger fa-fw"></i> MS Authenticator Passwordless</td>
													<td class="text-end">{{auth_method_adoption_data.3}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-warning fa-fw"></i> MS Authenticator Push</td>
													<td class="text-end">{{auth_method_adoption_data.4}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-info fa-fw"></i> Software OTP</td>
													<td class="text-end">{{auth_method_adoption_data.5}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-light fa-fw"></i> Mobile Phone</td>
													<td class="text-end">{{auth_method_adoption_data.6}}</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div class="col-12 col-md-6 col-xxl-3 d-flex order-1 order-xxl-3">
							<div class="card flex-fill w-100">
								<div class="card-header">
									<h5 class="card-title mb-0">Highest Auth Method Adoption</h5>
								</div>
								<div class="card-body d-flex">
									<div class="align-self-center w-100">
										<div class="py-3">
											<div class="chart chart-xs">
												<canvas id="highest-auth-pie"></canvas>
											</div>
										</div>

										<table class="table mb-0">
											<tbody>
												<tr>
													<td><i class="fas fa-circle text-primary fa-fw"></i> Phishing Resistant</td>
													<td class="text-end">{{auth_method_data.0}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-secondary fa-fw"></i> Passwordless</td>
													<td class="text-end">{{auth_method_data.1}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-success fa-fw"></i> MFA</td>
													<td class="text-end">{{auth_method_data.2}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-danger fa-fw"></i> Deprecated</td>
													<td class="text-end">{{auth_method_data.3}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-warning fa-fw"></i> None</td>
													<td class="text-end">{{auth_method_data.4}}</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div class="col-12 col-md-6 col-xxl-3 d-flex order-1 order-xxl-3">
							<div class="card flex-fill w-100">
								<div class="card-header">
									<h5 class="card-title mb-0">Lowest Auth Methods</h5>
								</div>
								<div class="card-body d-flex">
									<div class="align-self-center w-100">
										<div class="py-3">
											<div class="chart chart-xs">
												<canvas id="lowest-auth-pie"></canvas>
											</div>
										</div>

										<table class="table mb-0">
											<tbody>
												<tr>
													<td><i class="fas fa-circle text-primary fa-fw"></i> {{auth_method_low_labels.0}}</td>
													<td class="text-end">{{auth_method_low_data.0}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-secondary fa-fw"></i> {{auth_method_low_labels.1}}</td>
													<td class="text-end">{{auth_method_low_data.1}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-success fa-fw"></i> {{auth_method_low_labels.2}}</td>
													<td class="text-end">{{auth_method_low_data.2}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-danger fa-fw"></i> {{auth_method_low_labels.3}}</td>
													<td class="text-end">{{auth_method_low_data.3}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-warning fa-fw"></i> {{auth_method_low_labels.4}}</td>
													<td class="text-end">{{auth_method_low_data.4}}</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div class="col-12 col-md-6 col-xxl-3 d-flex order-1 order-xxl-3">
							<div class="card flex-fill w-100">
								<div class="card-header">
									<h5 class="card-title mb-0">Passwordless Capable Users</h5>
								</div>
								<div class="card-body d-flex">
									<div class="align-self-center w-100">
										<div class="py-3">
											<div class="chart chart-xs">
												<canvas id="full-passwordless-capable-pie"></canvas>
											</div>
										</div>

										<table class="table mb-0">
											<tbody>
												<tr>
													<td><i class="fas fa-circle text-success fa-fw"></i> Passwordless Capable</td>
													<td class="text-end">{{count_passwordless_capable_data.0}}</td>
												</tr>
												<tr>
													<td><i class="fas fa-circle text-danger fa-fw"></i> Non-Passwordless Capable</td>
													<td class="text-end">{{count_passwordless_capable_data.1}}</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="mb-3">
						<h1 class="h3 d-inline align-middle">Legacy Authentication Users</h1>
					</div>
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-body">
									<!-- Filter Dropdown -->
									<div class="row mb-3">
										<div class="col-md-6">
											<label for="highest-auth-strength-filter">Filter by Highest Authentication Strength:</label>
											<select id="highest-auth-strength-filter" class="form-control" multiple="multiple">
												{% for auth_strength in auth_strengths %}
												<option value="{{ auth_strength }}">{{ auth_strength }}</option>
												{% endfor %}
											</select>
										</div>
										<div class="col-md-6">
											<label for="lowest-auth-strength-filter">Filter by Lowest Authentication Strength:</label>
											<select id="lowest-auth-strength-filter" class="form-control" multiple="multiple">
												{% for auth_strength in auth_strengths %}
												<option value="{{ auth_strength }}">{{ auth_strength }}</option>
												{% endfor %}
											</select>
										</div>
									</div>
									<table id="datatables-responsive" class="table table-striped" style="width:100%">
										<thead>
											<tr>
												<th>UPN</th>
												<th>Created At</th>
												<th>Last Sign-on</th>
												<th>Highest Authentication Strength</th>
												<th>Lowest Authentication Strength</th>
												<th>Passkey</th>
												<th>MS Auth Passkey</th>
												<th>WHfB</th>
												<th>MS Auth Phone Sign-in</th>
												<th>MS Auth</th>
												<th>OTP</th>
												<th>TAP</th>
												<th>Phone</th>
												<th>Email</th>
												<th>Sec. Qs</th>
											</tr>
										</thead>
										<tbody>
											{% for user in user_list %}
											<tr>
												{% for check in user %}
												{% if check == True %}
												<td class="text-success">&#9989;</td>
												{% elif check == False %}
												<td class="text-danger">&#10060;</td>
												{% elif check == None %}
												<td class="text-danger">&#10060;</td>
												{% else %}
												<td><a href="/device/{{check.id}}">{{check.upn}}</a></td>
												<td>{{check.created_at_timestamp}}</td>
												<td>{{check.last_logon_timestamp}}</td>
												<td>{{check.highest_authentication_strength}}</td>
												<td>{{check.lowest_authentication_strength}}</td>
												{% endif %}
												{% endfor %}
											</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
			{% endblock %}
			{% block extra_js %}
			<!-- Include jQuery first -->
			<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
			<!-- Include Select2 CSS and JS -->
			<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
			<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
			<!-- Include DataTables CSS and JS -->
			<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
			<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
			<!-- Include DataTables Buttons extension CSS and JS -->
			<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.0.0/css/buttons.dataTables.min.css">
			<script src="https://cdn.datatables.net/buttons/2.0.0/js/dataTables.buttons.min.js"></script>
			<script src="https://cdn.datatables.net/buttons/2.0.0/js/buttons.html5.min.js"></script>
			<!-- <script src="https://cdn.datatables.net/buttons/2.0.0/js/buttons.print.min.js"></script> -->
			<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>	
			<script>
				document.addEventListener("DOMContentLoaded", function() {
					// Pie chart
					new Chart(document.getElementById("adoption-auth-pie"), {
						type: "pie",
						data: {
							labels: {{ auth_method_adoption_labels|safe }},
							datasets: [{ 
								data: {{ auth_method_adoption_data|safe }},
								backgroundColor: [
									window.theme.success,
									window.theme.danger
								],
								borderWidth: 5,
								borderColor: window.theme.white
							}]
						},
						options: {
							responsive: !window.MSInputMethodContext,
							maintainAspectRatio: false,
							legend: {
								display: false
							},
							cutoutPercentage: 70
						}
					});
				});
			</script>
			<script>
				document.addEventListener("DOMContentLoaded", function() {
					// Pie chart
					new Chart(document.getElementById("highest-auth-pie"), {
						type: "pie",
						data: {
							labels: {{ auth_method_labels|safe }},
							datasets: [{ 
								data: {{ auth_method_data|safe }},
								backgroundColor: [
									window.theme.primary,
									window.theme.secondary,
									window.theme.success,
									window.theme.danger,
									window.theme.warning
								],
								borderWidth: 5,
								borderColor: window.theme.white
							}]
						},
						options: {
							responsive: !window.MSInputMethodContext,
							maintainAspectRatio: false,
							legend: {
								display: false
							},
							cutoutPercentage: 70
						}
					});
				});
			</script>
			<script>
				document.addEventListener("DOMContentLoaded", function() {
					// Pie chart
					new Chart(document.getElementById("full-passwordless-pie"), {
						type: "pie",
						data: {
							labels: {{ count_passwordless_labels|safe }},
							datasets: [{ 
								data: {{ count_passwordless_data|safe }},
								backgroundColor: [
									window.theme.success,
									window.theme.danger
								],
								borderWidth: 5,
								borderColor: window.theme.white
							}]
						},
						options: {
							responsive: !window.MSInputMethodContext,
							maintainAspectRatio: false,
							legend: {
								display: false
							},
							cutoutPercentage: 70
						}
					});
				});
			</script>
			<script>
				document.addEventListener("DOMContentLoaded", function() {
					// Pie chart
					new Chart(document.getElementById("full-passwordless-capable-pie"), {
						type: "pie",
						data: {
							labels: {{ count_passwordless_capable_labels|safe }},
							datasets: [{ 
								data: {{ count_passwordless_capable_data|safe }},
								backgroundColor: [
									window.theme.success,
									window.theme.danger
								],
								borderWidth: 5,
								borderColor: window.theme.white
							}]
						},
						options: {
							responsive: !window.MSInputMethodContext,
							maintainAspectRatio: false,
							legend: {
								display: false
							},
							cutoutPercentage: 70
						}
					});
				});
			</script>
			<script>
				document.addEventListener("DOMContentLoaded", function() {
					// Pie chart
					new Chart(document.getElementById("lowest-auth-pie"), {
						type: "pie",
						data: {
							labels: {{ auth_method_low_labels|safe }},
							datasets: [{ 
								data: {{ auth_method_low_data|safe }},
								backgroundColor: [
									window.theme.primary,
									window.theme.secondary,
									window.theme.success,
									window.theme.danger,
									window.theme.warning
								],
								borderWidth: 5,
								borderColor: window.theme.white
							}]
						},
						options: {
							responsive: !window.MSInputMethodContext,
							maintainAspectRatio: false,
							legend: {
								display: false
							},
							cutoutPercentage: 70
						}
					});
				});
			</script>
			<script>
				document.addEventListener("DOMContentLoaded", function () {
					// Initialize Select2 for multi-select dropdown
					if ($.fn.select2) {
						$('#highest-auth-strength-filter').select2({
							placeholder: "Select Authentication Strength(s)",
							allowClear: true
						});
						$('#lowest-auth-strength-filter').select2({
							placeholder: "Select Authentication Strength(s)",
							allowClear: true
						});
					} else {
						console.error("Select2 library is not loaded.");
					}

					// Initialize DataTables
					if ($.fn.DataTable) {
						var table = $("#datatables-responsive").DataTable({
							responsive: true,
							dom: 'Bfrtip',
							buttons: [
								'excelHtml5',
								'pdfHtml5',
								'print'
							],
							columnDefs: [
								{
									targets: [3, 4], // Indices of columns to hide
									visible: false
								}
							]
						});

						// Apply the filters
						function applyFilters() {
							var selectedHighestAuthStrengths = $('#highest-auth-strength-filter').val();
							var selectedLowestAuthStrengths = $('#lowest-auth-strength-filter').val();

							var highestAuthStrengthRegex = selectedHighestAuthStrengths ? selectedHighestAuthStrengths.join('|') : '';
							var lowestAuthStrengthRegex = selectedLowestAuthStrengths ? selectedLowestAuthStrengths.join('|') : '';

							table
								.column(3).search(highestAuthStrengthRegex, true, false)
								.column(4).search(lowestAuthStrengthRegex, true, false)
								.draw();
						}

						$('#highest-auth-strength-filter').on('change', applyFilters);
						$('#lowest-auth-strength-filter').on('change', applyFilters);
					} else {
						console.error("DataTables library is not loaded.");
					}
				});
			</script>
{% endblock %}